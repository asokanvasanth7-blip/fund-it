<div class="update-loan-container">
  <header class="page-header">
    <h1>Update Loan Details</h1>
    <p class="subtitle">Manage fund amounts and loan amounts for member accounts</p>
  </header>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Loading accounts...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <p class="error-message">{{ error }}</p>
    <button (click)="loadAccounts()" class="retry-button">Retry</button>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading && !error" class="content-layout">
    <!-- Accounts Sidebar -->
    <div class="accounts-sidebar">
      <div class="sidebar-header">
        <h3>Accounts</h3>
        <span class="account-count">{{ filteredAccounts.length }}</span>
      </div>

      <!-- Search Bar -->
      <div class="search-container">
        <input
          type="text"
          class="search-input"
          [(ngModel)]="searchTerm"
          (ngModelChange)="filterAccounts()"
          placeholder="Search by name or ID..."
        />
        <span class="search-icon">üîç</span>
      </div>

      <div class="accounts-list">
        <div
          *ngFor="let account of filteredAccounts"
          class="account-card"
          [class.selected]="selectedAccount?.account === account.account"
          (click)="selectAccount(account)">
          <div class="card-header">
            <div class="account-badge">{{ account.account }}</div>
          </div>
          <div class="account-name">{{ account.name }}</div>
          <div class="card-footer">
            <div class="info-item">
              <span class="info-label">Fund:</span>
              <span class="info-value">‚Çπ{{ account.fund_amount | number:'1.0-0' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Loan:</span>
              <span class="info-value loan-value">‚Çπ{{ account.loan_amount | number:'1.0-0' }}</span>
            </div>
          </div>
        </div>

        <!-- No Results Message -->
        <div *ngIf="filteredAccounts.length === 0" class="no-results">
          <p>No accounts found</p>
          <small>Try a different search term</small>
        </div>
      </div>
    </div>

    <!-- Account Details Section -->
    <div class="details-section">
      <div *ngIf="!selectedAccount" class="empty-selection">
        <div class="empty-icon">üí∞</div>
        <p>Select an account to update loan details</p>
      </div>

      <div *ngIf="selectedAccount" class="account-details">
        <div class="details-header">
          <div>
            <h2>{{ selectedAccount.name }}</h2>
            <p class="account-subtitle">Account: {{ selectedAccount.account }}</p>
          </div>
          <div class="header-actions">
            <button (click)="openRepaymentModal()" class="repayment-btn" [disabled]="selectedAccount.loan_amount <= 0">
              üí∞ Loan Repayment
            </button>
            <button (click)="openEditModal()" class="edit-btn">
              ‚úèÔ∏è Edit Loan Details
            </button>
          </div>
        </div>

        <div class="details-cards">
          <div class="detail-card fund-card">
            <div class="card-icon">üíµ</div>
            <div class="card-content">
              <h3>Fund Amount</h3>
              <p class="amount">‚Çπ{{ selectedAccount.fund_amount | number:'1.2-2' }}</p>
              <small>Total fund contributed by member</small>
            </div>
          </div>

          <div class="detail-card loan-card">
            <div class="card-icon">üí≥</div>
            <div class="card-content">
              <h3>Loan Amount</h3>
              <p class="amount">‚Çπ{{ selectedAccount.loan_amount | number:'1.2-2' }}</p>
              <small>Total loan amount taken</small>
            </div>
          </div>

          <div class="detail-card balance-card">
            <div class="card-icon">üìä</div>
            <div class="card-content">
              <h3>Net Balance</h3>
              <p class="amount" [class.positive]="selectedAccount.fund_amount > selectedAccount.loan_amount" [class.negative]="selectedAccount.fund_amount < selectedAccount.loan_amount">
                ‚Çπ{{ (selectedAccount.fund_amount - selectedAccount.loan_amount) | number:'1.2-2' }}
              </p>
              <small>Fund amount minus loan amount</small>
            </div>
          </div>
        </div>

        <div class="info-panel">
          <div class="info-icon">‚ÑπÔ∏è</div>
          <div>
            <p><strong>About Loan Details:</strong></p>
            <ul>
              <li><strong>Fund Amount:</strong> The total amount contributed by the member to the fund</li>
              <li><strong>Loan Amount:</strong> The total amount borrowed by the member from the fund</li>
              <li><strong>Net Balance:</strong> Positive means member has more funds than loans, negative means more loans than funds</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div *ngIf="showEditModal && selectedAccount" class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div>
          <h2>Update Loan Details</h2>
          <p class="modal-subtitle">{{ selectedAccount.name }} ({{ selectedAccount.account }})</p>
        </div>
        <button class="close-button" (click)="closeModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <form (ngSubmit)="saveLoanDetails()">
          <div class="form-group">
            <label for="fundAmount">Fund Amount (‚Çπ) *</label>
            <input
              type="number"
              id="fundAmount"
              [(ngModel)]="editedFundAmount"
              name="fundAmount"
              class="form-control"
              step="0.01"
              min="0"
              required
            />
            <small class="form-hint">Total amount contributed to the fund</small>
          </div>

          <div class="form-group">
            <label for="loanAmount">Loan Amount (‚Çπ) *</label>
            <input
              type="number"
              id="loanAmount"
              [(ngModel)]="editedLoanAmount"
              name="loanAmount"
              class="form-control"
              step="0.01"
              min="0"
              required
            />
            <small class="form-hint">Total loan amount taken from the fund</small>
          </div>

          <div class="summary-box">
            <div class="summary-row">
              <span class="summary-label">Net Balance:</span>
              <span class="summary-value" [class.positive]="editedFundAmount > editedLoanAmount" [class.negative]="editedFundAmount < editedLoanAmount">
                ‚Çπ{{ (editedFundAmount - editedLoanAmount) | number:'1.2-2' }}
              </span>
            </div>
          </div>

          <div *ngIf="saveSuccess" class="success-message">
            ‚úÖ Loan details updated successfully!
          </div>

          <div *ngIf="saveError" class="error-message">
            ‚ùå {{ saveError }}
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" (click)="closeModal()" class="btn-cancel">Cancel</button>
        <button type="button" (click)="saveLoanDetails()" [disabled]="saving" class="btn-save">
          {{ saving ? 'Saving...' : 'Save Changes' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Loan Repayment Modal -->
  <div *ngIf="showRepaymentModal && selectedAccount" class="modal-overlay" (click)="closeRepaymentModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div>
          <h2>Process Loan Repayment</h2>
          <p class="modal-subtitle">{{ selectedAccount.name }} ({{ selectedAccount.account }})</p>
        </div>
        <button class="close-button" (click)="closeRepaymentModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="current-loan-info">
          <div class="info-row">
            <span class="info-label">Current Loan Balance:</span>
            <span class="info-value-large">‚Çπ{{ selectedAccount.loan_amount | number:'1.2-2' }}</span>
          </div>
        </div>

        <form (ngSubmit)="processLoanRepayment()">
          <div class="form-group">
            <label for="repaymentAmount">Repayment Amount (‚Çπ) *</label>
            <input
              type="number"
              id="repaymentAmount"
              [(ngModel)]="repaymentAmount"
              name="repaymentAmount"
              class="form-control"
              step="0.01"
              min="0.01"
              [max]="selectedAccount.loan_amount"
              required
            />
            <small class="form-hint">Enter the amount being repaid (max: ‚Çπ{{ selectedAccount.loan_amount | number:'1.2-2' }})</small>
          </div>

          <div class="form-group">
            <label for="repaymentDate">Repayment Date *</label>
            <input
              type="date"
              id="repaymentDate"
              [(ngModel)]="repaymentDate"
              name="repaymentDate"
              class="form-control"
              required
            />
            <small class="form-hint">Date when the repayment is made</small>
          </div>

          <div class="form-group">
            <label for="repaymentNotes">Notes (Optional)</label>
            <textarea
              id="repaymentNotes"
              [(ngModel)]="repaymentNotes"
              name="repaymentNotes"
              class="form-control"
              rows="3"
              placeholder="Add any notes about this repayment..."
            ></textarea>
          </div>

          <div class="summary-box" *ngIf="repaymentAmount > 0">
            <div class="summary-row">
              <span class="summary-label">Current Loan:</span>
              <span class="summary-value">‚Çπ{{ selectedAccount.loan_amount | number:'1.2-2' }}</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Repayment:</span>
              <span class="summary-value repayment">- ‚Çπ{{ repaymentAmount | number:'1.2-2' }}</span>
            </div>
            <div class="summary-row highlight">
              <span class="summary-label"><strong>New Loan Balance:</strong></span>
              <span class="summary-value"><strong>‚Çπ{{ (selectedAccount.loan_amount - repaymentAmount) | number:'1.2-2' }}</strong></span>
            </div>
          </div>

          <div *ngIf="saveSuccess" class="success-message">
            ‚úÖ Loan repayment processed successfully!
          </div>

          <div *ngIf="saveError" class="error-message">
            ‚ùå {{ saveError }}
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" (click)="closeRepaymentModal()" class="btn-cancel">Cancel</button>
        <button type="button" (click)="processLoanRepayment()" [disabled]="saving || repaymentAmount <= 0" class="btn-save">
          {{ saving ? 'Processing...' : 'Process Repayment' }}
        </button>
      </div>
    </div>
  </div>
</div>

