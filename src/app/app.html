<!-- Side Navigation Layout -->
<div class="app-container">
  <!-- Sidebar (Only visible when logged in) -->
  <ng-container *ngIf="user$ | async as user">
    <aside class="sidebar" [class.sidebar-collapsed]="sidebarCollapsed" [class.active]="!sidebarCollapsed && isMobile">
      <!-- Logo Section -->
      <div class="sidebar-header">
        <div class="logo-container">
          <span class="logo-icon">ğŸ’°</span>
          <span class="logo-text" [hidden]="sidebarCollapsed && !isMobile">Fund<span class="logo-highlight">It</span></span>
        </div>
      </div>

      <!-- Navigation Menu -->
      <nav class="sidebar-nav">
        <ul class="nav-list">
          <li class="nav-item">
            <a routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" class="nav-link">
              <span class="nav-icon">ğŸ </span>
              <span class="nav-text" [hidden]="sidebarCollapsed && !isMobile">Home</span>
            </a>
          </li>
          <li class="nav-item">
            <a routerLink="/account-details" routerLinkActive="active" class="nav-link">
              <span class="nav-icon">ğŸ‘¥</span>
              <span class="nav-text" [hidden]="sidebarCollapsed && !isMobile">Accounts</span>
            </a>
          </li>
          <li class="nav-item">
            <a routerLink="/payment-collection" routerLinkActive="active" class="nav-link">
              <span class="nav-icon">ğŸ’³</span>
              <span class="nav-text" [hidden]="sidebarCollapsed && !isMobile">Collect Payment</span>
            </a>
          </li>
          <li class="nav-item">
            <a routerLink="/update-due-details" routerLinkActive="active" class="nav-link">
              <span class="nav-icon">âœï¸</span>
              <span class="nav-text" [hidden]="sidebarCollapsed && !isMobile">Update Due</span>
            </a>
          </li>
          <li class="nav-item">
            <a routerLink="/update-loan-details" routerLinkActive="active" class="nav-link">
              <span class="nav-icon">ğŸ’°</span>
              <span class="nav-text" [hidden]="sidebarCollapsed && !isMobile">Update Loan</span>
            </a>
          </li>
          <li class="nav-item">
            <a routerLink="/due-schedule" routerLinkActive="active" class="nav-link">
              <span class="nav-icon">ğŸ“…</span>
              <span class="nav-text" [hidden]="sidebarCollapsed && !isMobile">Due Schedule</span>
            </a>
          </li>
          <li class="nav-item">
            <a routerLink="/due-report" routerLinkActive="active" class="nav-link">
              <span class="nav-icon">ğŸ“Š</span>
              <span class="nav-text" [hidden]="sidebarCollapsed && !isMobile">Due Report</span>
            </a>
          </li>
          <li class="nav-item">
            <a routerLink="/bulk-fund-update" routerLinkActive="active" class="nav-link">
              <span class="nav-icon">ğŸ“¦</span>
              <span class="nav-text" [hidden]="sidebarCollapsed && !isMobile">Bulk Fund Update</span>
            </a>
          </li>
          <li class="nav-item">
            <a routerLink="/upload" routerLinkActive="active" class="nav-link">
              <span class="nav-icon">ğŸ“¤</span>
              <span class="nav-text" [hidden]="sidebarCollapsed && !isMobile">Upload Data</span>
            </a>
          </li>
        </ul>
      </nav>

      <!-- Auth Section at Bottom -->
      <div class="sidebar-footer">
        <div class="user-section">
          <div class="user-info" [hidden]="sidebarCollapsed && !isMobile">
            <img *ngIf="user.photoURL" [src]="user.photoURL" class="sidebar-profile-image" alt="Profile" referrerpolicy="no-referrer">
            <div *ngIf="!user.photoURL" class="sidebar-profile-avatar">
              {{ (user.displayName || user.email || 'U').charAt(0).toUpperCase() }}
            </div>
            <div class="user-details">
              <span class="user-name">{{ getUserDisplayName() }}</span>
              <span class="user-email">{{ user.email }}</span>
            </div>
          </div>
          <button class="btn-logout" (click)="logout()" [title]="sidebarCollapsed ? getUserDisplayName() : ''">
            <span [hidden]="sidebarCollapsed && !isMobile">Logout</span>
            <span [hidden]="!sidebarCollapsed || isMobile">ğŸšª</span>
          </button>
        </div>
      </div>

      <!-- Toggle Button -->
      <button class="sidebar-toggle" (click)="toggleSidebar()">
        <span *ngIf="!sidebarCollapsed">â—€</span>
        <span *ngIf="sidebarCollapsed">â–¶</span>
      </button>
    </aside>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" [class.active]="!sidebarCollapsed && isMobile" (click)="toggleSidebar()"></div>
  </ng-container>

  <!-- Main Content Area -->
  <main class="main-content" [class.main-content-expanded]="sidebarCollapsed" [class.no-sidebar]="!(user$ | async)">
    <!-- App Header (Desktop) -->
    <header class="app-header" *ngIf="user$ | async as user">
      <div class="header-content">
        <div class="header-left">
          <h2 class="header-title">Azhisukudi Amavasai Fund</h2>
        </div>
        <div class="header-right">
          <!-- Profile Dropdown -->
          <div class="profile-container">
            <button class="profile-trigger" (click)="toggleProfileDropdown($event)">
              <img
                *ngIf="user.photoURL"
                [src]="user.photoURL"
                alt="Profile"
                class="profile-image"
                referrerpolicy="no-referrer">
              <div *ngIf="!user.photoURL" class="profile-avatar">
                {{ (user.displayName || user.email || 'U').charAt(0).toUpperCase() }}
              </div>
              <span class="profile-name">{{ user.displayName || (user.email ? user.email.split('@')[0] : 'User') }}</span>
              <span class="dropdown-arrow" [class.open]="profileDropdownOpen">â–¼</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Top Bar for Mobile (Only visible when logged in) -->
    <div class="mobile-topbar" *ngIf="user$ | async as user">
      <button class="mobile-menu-btn" (click)="toggleSidebar()">
        â˜°
      </button>
      <div class="mobile-logo">
        <span>ğŸ’°</span>
        <span class="ms-2">Fund<span class="logo-highlight">It</span></span>
      </div>
      <!-- Mobile Profile -->
      <div class="mobile-profile">
        <button class="mobile-profile-btn" (click)="toggleProfileDropdown($event)">
          <img
            *ngIf="user.photoURL"
            [src]="user.photoURL"
            alt="Profile"
            class="mobile-profile-image"
            referrerpolicy="no-referrer">
          <div *ngIf="!user.photoURL" class="mobile-profile-avatar">
            {{ (user.displayName || user.email || 'U').charAt(0).toUpperCase() }}
          </div>
        </button>
      </div>
    </div>

    <router-outlet />
  </main>
</div>

<!-- Shared Profile Dropdown Menu (for both Desktop and Mobile) -->
<div class="profile-dropdown-wrapper" *ngIf="user$ | async as user">
  <div class="profile-dropdown" [class.show]="profileDropdownOpen" (click)="$event.stopPropagation()">
    <div class="dropdown-header">
      <div class="dropdown-profile-image">
        <img
          *ngIf="user.photoURL"
          [src]="user.photoURL"
          alt="Profile"
          referrerpolicy="no-referrer">
        <div *ngIf="!user.photoURL" class="dropdown-avatar">
          {{ (user.displayName || user.email || 'U').charAt(0).toUpperCase() }}
        </div>
      </div>
      <div class="dropdown-user-info">
        <h4>{{ user.displayName || (user.email ? user.email.split('@')[0] : 'User') }}</h4>
        <p>{{ user.email }}</p>
      </div>
    </div>
    <div class="dropdown-divider"></div>
    <div class="dropdown-body">
      <a routerLink="/dashboard" class="dropdown-item" (click)="closeProfileDropdown()">
        <span class="item-icon">ğŸ“Š</span>
        <span>Dashboard</span>
      </a>
      <a routerLink="/account-details" class="dropdown-item" (click)="closeProfileDropdown()">
        <span class="item-icon">ğŸ‘¤</span>
        <span>My Profile</span>
      </a>
    </div>
    <div class="dropdown-divider"></div>
    <div class="dropdown-footer">
      <button class="dropdown-logout" (click)="logout()">
        <span class="item-icon">ğŸšª</span>
        <span>Logout</span>
      </button>
    </div>
  </div>
</div>

<!-- Profile Dropdown Overlay -->
<div class="profile-overlay" [class.active]="profileDropdownOpen" (click)="closeProfileDropdown()"></div>

<!-- Mobile Overlay -->
<div class="sidebar-overlay" [class.active]="!sidebarCollapsed" (click)="toggleSidebar()"></div>

<!-- PWA Install Prompt -->
<div class="pwa-install-banner" *ngIf="showInstallPrompt && !isStandalone">
  <div class="pwa-install-content">
    <div class="pwa-install-icon">ğŸ“±</div>
    <div class="pwa-install-text">
      <h4>Install FundIt App</h4>
      <p>Get quick access and work offline</p>
    </div>
    <div class="pwa-install-actions">
      <button class="pwa-install-btn" (click)="installPwa()">Install</button>
      <button class="pwa-dismiss-btn" (click)="dismissInstallPrompt()">âœ•</button>
    </div>
  </div>
</div>
