<div class="payment-collection-container">
  <header class="page-header">
    <h1>Payment Collection</h1>
    <p class="subtitle">Collect and record due payments from accounts</p>
  </header>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Loading accounts...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <p class="error-message">{{ error }}</p>
    <button (click)="loadAccounts()" class="retry-button">Retry</button>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading && !error" class="content-layout">
    <!-- Accounts List -->
    <div class="accounts-sidebar">
      <div class="sidebar-header">
        <h3>Accounts</h3>
        <span class="account-count">{{ filteredAccounts.length }}</span>
      </div>

      <!-- Search Bar -->
      <div class="search-container">
        <input
          type="text"
          class="search-input"
          [(ngModel)]="searchTerm"
          (ngModelChange)="filterAccounts()"
          placeholder="Search by name or ID..."
        />
        <span class="search-icon">🔍</span>
      </div>

      <div class="accounts-list">
        <div
          *ngFor="let account of filteredAccounts"
          class="account-card-modern"
          [class.selected]="selectedAccount?.account === account.account"
          (click)="selectAccount(account)">

          <!-- Profile Avatar -->
          <div class="account-avatar">
            <div class="avatar-circle" [style.background]="getAvatarColor(account.account)">
              {{ getInitials(account.name) }}
            </div>
          </div>

          <!-- Account Info -->
          <div class="account-info-section">
            <h4 class="account-name-modern">{{ account.name }}</h4>

            <div class="account-contact">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              <span>{{ account.account }}</span>
            </div>

            <div class="account-contact" *ngIf="account.mobile">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
              </svg>
              <span>{{ account.mobile }}</span>
            </div>
          </div>

          <!-- Status Badge & Points -->
          <div class="account-status-section">
            <span class="role-badge">{{account.account}}</span>
            <div class="pending-points">
              <div class="points-value">{{ getTotalPendingAmount(account) | number:'1.0-0' }}</div>
              <div class="points-label">Pending</div>
            </div>
          </div>
        </div>

        <!-- No Results Message -->
        <div *ngIf="filteredAccounts.length === 0" class="no-results">
          <p>No accounts found</p>
          <small>Try a different search term</small>
        </div>
      </div>
    </div>

    <!-- Payments List -->
    <div class="payments-section">
      <div *ngIf="!selectedAccount" class="empty-selection">
        <p>👈 Select an account to view pending payments</p>
      </div>

      <div *ngIf="selectedAccount">
        <div class="account-info">
          <div>
            <h2>{{ selectedAccount.name }}</h2>
            <p class="account-subtitle">Account: {{ selectedAccount.account }}</p>
          </div>
          <div class="account-stats">
            <div class="stat-item">
              <span class="stat-label">Total Payments:</span>
              <span class="stat-value">{{ selectedAccount.due_payments?.length || 0 }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Pending:</span>
              <span class="stat-value">{{ getPendingPayments(selectedAccount).length }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Total Pending:</span>
              <span class="stat-value amount">₹{{ getTotalPendingAmount(selectedAccount) | number:'1.2-2' }}</span>
            </div>
          </div>
        </div>

        <!-- Filter Options -->
        <div class="filter-section">
          <label class="filter-label">Filter by Status:</label>
          <div class="filter-buttons">
            <button
              [class.active]="paymentFilter === 'all'"
              (click)="paymentFilter = 'all'"
              class="filter-btn">
              All ({{ selectedAccount.due_payments?.length || 0 }})
            </button>
            <button
              [class.active]="paymentFilter === 'pending'"
              (click)="paymentFilter = 'pending'"
              class="filter-btn">
              Pending ({{ getPendingCount(selectedAccount) }})
            </button>
            <button
              [class.active]="paymentFilter === 'partial'"
              (click)="paymentFilter = 'partial'"
              class="filter-btn">
              Partial ({{ getPartialCount(selectedAccount) }})
            </button>
            <button
              [class.active]="paymentFilter === 'paid'"
              (click)="paymentFilter = 'paid'"
              class="filter-btn">
              Paid ({{ getPaidCount(selectedAccount) }})
            </button>
          </div>
        </div>

        <div *ngIf="getFilteredPayments(selectedAccount).length === 0" class="no-pending">
          <p>📭 No payments found for the selected filter.</p>
        </div>

        <div *ngIf="getFilteredPayments(selectedAccount).length > 0">
          <!-- Desktop Table View -->
          <div class="table-container desktop-view">
            <table class="payments-table">
              <thead>
                <tr>
                  <th>Due No.</th>
                  <th>Due Date</th>
                  <th>Total Due</th>
                  <th>Paid Amount</th>
                  <th>Balance</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let payment of getFilteredPayments(selectedAccount)">
                  <td class="center">{{ payment.due_no }}</td>
                  <td>{{ payment.due_date }}</td>
                  <td class="amount">₹{{ payment.total | number:'1.2-2' }}</td>
                  <td class="amount">₹{{ payment.paid_amount | number:'1.2-2' }}</td>
                  <td class="amount balance">₹{{ getRemainingBalance(payment) | number:'1.2-2' }}</td>
                  <td class="center">
                    <span [class]="'status-badge ' + getPaymentStatusClass(payment.payment_status)">
                      {{ payment.payment_status }}
                    </span>
                  </td>
                  <td class="center">
                    <div class="action-buttons">
                      <button
                        *ngIf="payment.payment_status !== 'paid' && getRemainingBalance(payment) > 0"
                        (click)="openPaymentModal(payment)"
                        class="collect-btn"
                        [disabled]="!hasEditAccess || !canCollectPayment(payment)"
                        [title]="!hasEditAccess ? 'You do not have permission to collect payments' : (!canCollectPayment(payment) ? 'Payment collection only allowed for current month dues with valid due dates' : 'Collect payment for this due')">
                        💰 Collect
                      </button>
                      <button
                        (click)="sendWhatsAppReceipt(payment)"
                        class="whatsapp-btn"
                        title="Send receipt via WhatsApp">
                        📱 WhatsApp
                      </button>
                      <button
                        (click)="exportPDFReceipt(payment)"
                        class="pdf-btn"
                        title="Export receipt as PDF">
                        📄 PDF
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Mobile Card View -->
          <div class="mobile-cards-container mobile-view">
            <div *ngFor="let payment of getFilteredPayments(selectedAccount)" class="payment-card">
              <div class="payment-card-header">
                <div class="payment-due-number">Due #{{ payment.due_no }}</div>
                <span [class]="'status-badge ' + getPaymentStatusClass(payment.payment_status)">
                  {{ payment.payment_status }}
                </span>
              </div>

              <div class="payment-card-body">
                <div class="payment-info-row">
                  <span class="payment-label">📅 Due Date</span>
                  <span class="payment-value">{{ payment.due_date }}</span>
                </div>

                <div class="payment-info-row">
                  <span class="payment-label">💰 Total Due</span>
                  <span class="payment-value amount-large">₹{{ payment.total | number:'1.2-2' }}</span>
                </div>

                <div class="payment-info-row">
                  <span class="payment-label">✅ Paid Amount</span>
                  <span class="payment-value paid-color">₹{{ payment.paid_amount | number:'1.2-2' }}</span>
                </div>

                <div class="payment-info-row highlight-row">
                  <span class="payment-label">⚖️ Balance</span>
                  <span class="payment-value balance-large">₹{{ getRemainingBalance(payment) | number:'1.2-2' }}</span>
                </div>
              </div>

              <div class="payment-card-footer">
                <button
                  *ngIf="payment.payment_status !== 'paid' && getRemainingBalance(payment) > 0"
                  (click)="openPaymentModal(payment)"
                  class="collect-btn-mobile"
                  [disabled]="!hasEditAccess || !canCollectPayment(payment)"
                  [title]="!hasEditAccess ? 'You do not have permission to collect payments' : (!canCollectPayment(payment) ? 'Payment collection only allowed for current month dues with valid due dates' : 'Collect payment for this due')">
                  💰 Collect
                </button>
                <button
                  (click)="sendWhatsAppReceipt(payment)"
                  class="whatsapp-btn-mobile"
                  title="Send receipt via WhatsApp">
                  📱 WhatsApp
                </button>
                <button
                  (click)="exportPDFReceipt(payment)"
                  class="pdf-btn-mobile"
                  title="Export receipt as PDF">
                  📄 PDF
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  <div *ngIf="showPaymentModal && selectedPayment" class="modal-overlay" (click)="closePaymentModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Collect Payment - Due #{{ selectedPayment.due_no }}</h2>
        <button class="close-button" (click)="closePaymentModal()">✕</button>
      </div>

      <div class="modal-body">
        <div class="payment-summary">
          <div class="summary-row">
            <span class="label">Account:</span>
            <span class="value">{{ selectedAccount?.name }} ({{ selectedAccount?.account }})</span>
          </div>
          <div class="summary-row">
            <span class="label">Due Date:</span>
            <span class="value">{{ selectedPayment.due_date }}</span>
          </div>
          <div class="summary-row">
            <span class="label">Total Due:</span>
            <span class="value amount">₹{{ selectedPayment.total | number:'1.2-2' }}</span>
          </div>
          <div class="summary-row">
            <span class="label">Already Paid:</span>
            <span class="value amount success">₹{{ selectedPayment.paid_amount | number:'1.2-2' }}</span>
          </div>
          <div class="summary-row highlight">
            <span class="label">Remaining Balance:</span>
            <span class="value amount">₹{{ getRemainingBalance(selectedPayment) | number:'1.2-2' }}</span>
          </div>
        </div>

        <form (ngSubmit)="collectPayment()" class="payment-form">
          <div class="form-group">
            <label for="amountToPay">Payment Amount (₹) *</label>
            <input
              type="number"
              id="amountToPay"
              [(ngModel)]="amountToPay"
              name="amountToPay"
              class="form-control"
              step="0.01"
              min="0"
              [max]="getRemainingBalance(selectedPayment)"
              required>
            <small class="form-hint">Maximum: ₹{{ getRemainingBalance(selectedPayment) | number:'1.2-2' }}</small>
          </div>

          <div class="form-group">
            <label for="paymentDate">Payment Date *</label>
            <input
              type="date"
              id="paymentDate"
              [(ngModel)]="paymentDate"
              name="paymentDate"
              class="form-control"
              required>
          </div>

          <div class="form-group">
            <label for="paymentMethod">Payment Method *</label>
            <select
              id="paymentMethod"
              [(ngModel)]="paymentMethod"
              name="paymentMethod"
              class="form-control"
              required>
              <option value="cash">Cash</option>
              <option value="bank_transfer">Bank Transfer</option>
              <option value="upi">UPI</option>
              <option value="cheque">Cheque</option>
              <option value="card">Card</option>
            </select>
          </div>

          <div class="form-group">
            <label for="paymentNotes">Notes (Optional)</label>
            <textarea
              id="paymentNotes"
              [(ngModel)]="paymentNotes"
              name="paymentNotes"
              class="form-control"
              rows="3"
              placeholder="Add any notes about this payment..."></textarea>
          </div>

          <div *ngIf="paymentSuccess" class="success-message">
            ✅ Payment collected successfully!
          </div>

          <div *ngIf="paymentError" class="error-message">
            ❌ {{ paymentError }}
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" (click)="closePaymentModal()" class="btn-cancel">Cancel</button>
        <button type="button" (click)="collectPayment()" [disabled]="!hasEditAccess || processing || amountToPay <= 0" class="btn-collect">
          {{ processing ? 'Processing...' : 'Collect Payment' }}
        </button>
      </div>
    </div>
  </div>
</div>

